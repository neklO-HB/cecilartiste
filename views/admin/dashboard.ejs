<%- include('../partials/header') %>
<section class="admin-container">
    <header class="gallery-header">
        <div>
            <h1>Administration du portfolio</h1>
            <p>Connectée en tant que <%= currentUser ? currentUser.username : "Cecile" %>. Gérez vos images, vos catégories et votre email de contact en toute simplicité.</p>
        </div>
        <form action="/admin/logout" method="post">
            <button type="submit" class="button-secondary">Se déconnecter</button>
        </form>
</header>

    <nav class="admin-shortcuts" aria-label="Navigation rapide">
        <button type="button" class="button-secondary" data-admin-target="add-photo">Ajouter une photo</button>
        <button type="button" class="button-secondary" data-admin-target="photos">Vos photos</button>
        <button type="button" class="button-secondary" data-admin-target="categories">Catégories</button>
        <button type="button" class="button-secondary" data-admin-target="hero-intro">Présentation</button>
        <button type="button" class="button-secondary" data-admin-target="contact-settings">Contact</button>
        <button type="button" class="button-secondary" data-admin-target="messages">Messages</button>
    </nav>

    <% if (feedback) { %>
        <div class="notice"><%= feedback %></div>
    <% } %>

    <% if (errors && errors.length) { %>
        <% errors.forEach(error => { %>
            <div class="notice" role="alert"><%= error %></div>
        <% }) %>
    <% } %>

    <div class="admin-grid">
        <section class="admin-card" id="add-photo" data-admin-section="add-photo">
            <h2>Ajouter une nouvelle photo</h2>
            <form class="admin-form" method="post" action="/admin/photos" enctype="multipart/form-data">
                <div>
                    <label for="title">Titre</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div>
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="4" placeholder="Décrivez l'histoire derrière cette image..."></textarea>
                </div>
                <div>
                    <label for="palette">Palette</label>
                    <select id="palette" name="palette">
                        <option value="vibrant">Vibrant</option>
                        <option value="aurora">Aurora</option>
                        <option value="nocturne">Nocturne</option>
                        <option value="solaire">Solaire</option>
                    </select>
                </div>
                <div>
                    <label for="accent_color">Couleur d'accent</label>
                    <input type="color" id="accent_color" name="accent_color" value="#ff6f61">
                </div>
                <div>
                    <label for="category_id">Catégorie</label>
                    <select id="category_id" name="category_id">
                        <option value="">Sans catégorie</option>
                        <% if (categories && categories.length) { %>
                            <% categories.forEach(category => { %>
                                <option value="<%= category.id %>"><%= category.name %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                <div>
                    <label for="photo">Image</label>
                    <input type="file" id="photo" name="photo" accept="image/*" required>
                </div>
                <button type="submit" class="button-primary">Ajouter</button>
            </form>
        </section>

        <section class="admin-card" id="hero-intro" data-admin-section="hero-intro">
            <h2>Présentation «&nbsp;Qui suis-je&nbsp;?»</h2>
            <p>Personnalisez le texte introductif visible en haut de la page d'accueil pour présenter votre univers.</p>
            <form class="admin-form" method="post" action="/admin/hero-intro">
                <div>
                    <label for="hero_intro_heading">Titre court</label>
                    <input type="text" id="hero_intro_heading" name="hero_intro_heading" required value="<%= heroIntro.heading %>">
                </div>
                <div>
                    <label for="hero_intro_subheading">Titre principal</label>
                    <input type="text" id="hero_intro_subheading" name="hero_intro_subheading" required value="<%= heroIntro.subheading %>">
                </div>
                <div>
                    <label for="hero_intro_body">Texte de présentation</label>
                    <textarea id="hero_intro_body" name="hero_intro_body" rows="5" required><%= heroIntro.body %></textarea>
                    <small>Mettez en avant votre style, votre ancrage à Amiens et vos déplacements partout en France.</small>
                </div>
                <button type="submit" class="button-primary">Enregistrer</button>
            </form>
        </section>

        <section class="admin-card" id="contact-settings" data-admin-section="contact-settings">
            <h2>Paramètres de contact</h2>
            <form class="admin-form" method="post" action="/admin/contact-email">
                <div>
                    <label for="contact_email">Email destinataire</label>
                    <input type="email" id="contact_email" name="contact_email" required value="<%= contactEmail %>">
                </div>
                <button type="submit" class="button-primary">Mettre à jour</button>
            </form>
        </section>
    </div>

    <section class="admin-card admin-card--wide" id="categories" data-admin-section="categories">
        <h2>Catégories du portfolio</h2>
        <p>Personnalisez les univers présentés sur la page d'accueil et assignez vos photos aux bonnes thématiques.</p>
        <div class="category-manager">
            <div class="category-manager__column">
                <h3>Créer une catégorie</h3>
                <form class="admin-form" method="post" action="/admin/categories" enctype="multipart/form-data">
                    <div>
                        <label for="category_name">Nom</label>
                        <input type="text" id="category_name" name="name" required>
                    </div>
                    <div>
                        <label for="category_position">Position</label>
                        <input type="number" id="category_position" name="position" min="0" placeholder="0">
                    </div>
                    <div>
                        <label for="category_hero_image">Image de mise en avant</label>
                        <input type="file" id="category_hero_image" name="hero_image" accept="image/*" required>
                        <small>Format conseillé : photo horizontale. Cette image apparaîtra dans la mosaïque d'accueil.</small>
                    </div>
                    <button type="submit" class="button-primary">Créer</button>
                </form>
            </div>
            <div class="category-manager__column">
                <h3>Catégories existantes</h3>
                <% if (!categories || categories.length === 0) { %>
                    <p>Aucune catégorie définie pour le moment. Créez vos univers pour structurer votre portfolio.</p>
                <% } else { %>
                    <div class="category-list">
                        <% categories.forEach(category => { %>
                            <article class="category-item">
                                <div class="category-item__preview">
                                    <% if (category.hero_image_path) { %>
                                        <img src="<%= category.hero_image_path %>" alt="Visuel de la catégorie <%= category.name %>">
                                    <% } else { %>
                                        <div class="category-item__placeholder">Image à ajouter</div>
                                    <% } %>
                                </div>
                                <div class="category-item__content">
                                    <form class="admin-form" method="post" action="/admin/categories/<%= category.id %>" enctype="multipart/form-data">
                                        <div>
                                            <label for="category_name_<%= category.id %>">Nom</label>
                                            <input type="text" id="category_name_<%= category.id %>" name="name" required value="<%= category.name %>">
                                        </div>
                                        <div>
                                            <label for="category_position_<%= category.id %>">Position</label>
                                            <input type="number" id="category_position_<%= category.id %>" name="position" value="<%= category.position %>">
                                        </div>
                                        <div>
                                            <label for="category_image_<%= category.id %>">Remplacer l'image</label>
                                            <input type="file" id="category_image_<%= category.id %>" name="hero_image" accept="image/*">
                                        </div>
                                        <div class="admin-photo-actions">
                                            <button type="submit" class="button-secondary">Enregistrer</button>
                                        </div>
                                    </form>
                                    <form class="admin-form admin-form--delete" method="post" action="/admin/categories/<%= category.id %>/delete" onsubmit="return confirm('Supprimer cette catégorie ? Les photos associées resteront en ligne sans catégorie.');">
                                        <button type="submit" class="button-danger">Supprimer</button>
                                    </form>
                                </div>
                            </article>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </section>

    <section class="admin-card" id="photos" data-admin-section="photos">
        <h2>Vos photos</h2>
        <% if (!photos || photos.length === 0) { %>
            <p>Aucune photo pour le moment. Ajoutez vos œuvres pour les voir apparaître ici.</p>
        <% } else { %>
            <% const palettes = { vibrant: 'Vibrant', aurora: 'Aurora', nocturne: 'Nocturne', solaire: 'Solaire' }; %>
            <div class="admin-photos">
                <% photos.forEach(photo => { %>
                    <article class="admin-photo-item">
                        <img src="<%= photo.image_path %>" alt="<%= photo.title %>">
                        <div>
                            <h3><%= photo.title %></h3>
                            <% if (photo.description) { %>
                                <p><%- nl2br(photo.description) %></p>
                            <% } %>
                            <form class="admin-form" method="post" action="/admin/photos/<%= photo.id %>" enctype="multipart/form-data">
                                <div>
                                    <label for="title_<%= photo.id %>">Titre</label>
                                    <input type="text" id="title_<%= photo.id %>" name="title" required value="<%= photo.title %>">
                                </div>
                                <div>
                                    <label for="description_<%= photo.id %>">Description</label>
                                    <textarea id="description_<%= photo.id %>" name="description" rows="3"><%= photo.description || '' %></textarea>
                                </div>
                                <div>
                                    <label for="palette_<%= photo.id %>">Palette</label>
                                    <select id="palette_<%= photo.id %>" name="palette">
                                        <% Object.entries(palettes).forEach(([value, label]) => { %>
                                            <option value="<%= value %>" <%= photo.palette === value ? 'selected' : '' %>><%= label %></option>
                                        <% }) %>
                                    </select>
                                </div>
                                <div>
                                    <label for="accent_<%= photo.id %>">Couleur d'accent</label>
                                    <input type="color" id="accent_<%= photo.id %>" name="accent_color" value="<%= photo.accent_color || '#ff6f61' %>">
                                </div>
                                <div>
                                    <label for="category_<%= photo.id %>">Catégorie</label>
                                    <select id="category_<%= photo.id %>" name="category_id">
                                        <option value="" <%= !photo.category_id ? 'selected' : '' %>>Sans catégorie</option>
                                        <% if (categories && categories.length) { %>
                                            <% categories.forEach(category => { %>
                                                <option value="<%= category.id %>" <%= photo.category_id === category.id ? 'selected' : '' %>><%= category.name %></option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                </div>
                                <div>
                                    <label for="photo_<%= photo.id %>">Remplacer l'image</label>
                                    <input type="file" id="photo_<%= photo.id %>" name="photo" accept="image/*">
                                </div>
                                <div class="admin-photo-actions">
                                    <button type="submit" class="button-secondary">Enregistrer</button>
                                </div>
                            </form>
                            <form class="admin-form admin-form--delete" method="post" action="/admin/photos/<%= photo.id %>/delete" onsubmit="return confirm('Supprimer cette photo ?');">
                                <button type="submit" class="button-danger">Supprimer</button>
                            </form>
                        </div>
                    </article>
                <% }) %>
            </div>
        <% } %>
    </section>

    <section class="admin-card" id="messages" data-admin-section="messages">
        <h2>Messages reçus</h2>
        <% if (!messages || messages.length === 0) { %>
            <p>Aucun message pour le moment.</p>
        <% } else { %>
            <ul class="admin-messages">
                <% messages.forEach(message => { %>
                    <li>
                        <header>
                            <strong><%= message.name %></strong> – <a href="mailto:<%= message.email %>"><%= message.email %></a>
                            <span class="admin-message-date"><%= formatDate(message.created_at) %></span>
                        </header>
                        <p class="admin-message-subject"><strong>Objet :</strong> <%= message.subject %></p>
                        <p><%- nl2br(message.message) %></p>
                    </li>
                <% }) %>
            </ul>
        <% } %>
    </section>
    <script>
        (function () {
            const triggers = Array.from(document.querySelectorAll('[data-admin-target]'));
            const sections = Array.from(document.querySelectorAll('[data-admin-section]'));

            if (!triggers.length || !sections.length) {
                return;
            }

            const sectionsById = new Map(sections.map(section => [section.dataset.adminSection, section]));

            function activate(target, options) {
                const { scroll = true } = options || {};
                const activeSection = sectionsById.get(target);
                if (!activeSection) {
                    return;
                }

                sections.forEach(section => {
                    section.hidden = section !== activeSection;
                });

                triggers.forEach(trigger => {
                    trigger.classList.toggle('is-active', trigger.dataset.adminTarget === target);
                });

                if (window.location.hash !== `#${target}` && typeof history.replaceState === 'function') {
                    history.replaceState(null, '', `#${target}`);
                }

                if (scroll) {
                    activeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    activate(trigger.dataset.adminTarget, { scroll: true });
                });
            });

            const initialHash = window.location.hash ? window.location.hash.substring(1) : '';
            const initialTarget = sectionsById.has(initialHash)
                ? initialHash
                : triggers[0] && triggers[0].dataset.adminTarget;

            if (initialTarget) {
                activate(initialTarget, { scroll: false });
            }
        })();
    </script>
</section>
<%- include('../partials/footer') %>
