<%- include('../partials/header') %>
<section class="admin-container">
    <header class="gallery-header">
        <div>
            <h1>Administration du portfolio</h1>
            <p>Connect√©e en tant que <%= currentUser ? currentUser.username : "Cecile" %>. G√©rez vos images, vos cat√©gories et votre email de contact en toute simplicit√©.</p>
        </div>
        <form action="/admin/logout" method="post">
            <button type="submit" class="button-secondary">Se d√©connecter</button>
        </form>
</header>

    <nav class="admin-shortcuts" aria-label="Navigation rapide">
        <button type="button" class="button-secondary" data-admin-target="add-photo">Ajouter une photo</button>
        <button type="button" class="button-secondary" data-admin-target="photos">Vos photos</button>
        <button type="button" class="button-secondary" data-admin-target="categories">Cat√©gories</button>
        <button type="button" class="button-secondary" data-admin-target="hero-intro">Pr√©sentation</button>
        <button type="button" class="button-secondary" data-admin-target="experiences">Exp√©riences</button>
        <button type="button" class="button-secondary" data-admin-target="contact-settings">Contact</button>
        <button type="button" class="button-secondary" data-admin-target="messages">Messages</button>
    </nav>

    <% if (feedback) { %>
        <div class="notice"><%= feedback %></div>
    <% } %>

    <% if (errors && errors.length) { %>
        <% errors.forEach(error => { %>
            <div class="notice" role="alert"><%= error %></div>
        <% }) %>
    <% } %>

    <div class="admin-grid">
        <section class="admin-card" id="add-photo" data-admin-section="add-photo">
            <h2>Ajouter une nouvelle photo</h2>
            <form class="admin-form" method="post" action="/admin/photos" enctype="multipart/form-data">
                <div>
                    <label for="title">Titre</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div>
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="4" placeholder="D√©crivez l'histoire derri√®re cette image..."></textarea>
                </div>
                <div>
                    <label for="palette">Palette</label>
                    <select id="palette" name="palette">
                        <option value="vibrant">Vibrant</option>
                        <option value="chromatique">Chromatique</option>
                        <option value="pastel">Pastel</option>
                        <option value="solaire">Solaire</option>
                    </select>
                </div>
                <div>
                    <label for="accent_color">Couleur d'accent</label>
                    <input type="color" id="accent_color" name="accent_color" value="#ff6f61">
                </div>
                <div>
                    <label for="category_id">Cat√©gorie</label>
                    <select id="category_id" name="category_id">
                        <option value="">Sans cat√©gorie</option>
                        <% if (categories && categories.length) { %>
                            <% categories.forEach(category => { %>
                                <option value="<%= category.id %>"><%= category.name %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                <div>
                    <label for="photo">Image</label>
                    <input type="file" id="photo" name="photo" accept="image/*" required>
                </div>
                <button type="submit" class="button-primary">Ajouter</button>
            </form>
        </section>

        <section class="admin-card" id="hero-intro" data-admin-section="hero-intro">
            <h2>Pr√©sentation ¬´&nbsp;Qui suis-je&nbsp;?¬ª</h2>
            <p>Personnalisez le texte introductif visible en haut de la page d'accueil pour pr√©senter votre univers.</p>
            <form class="admin-form" method="post" action="/admin/hero-intro">
                <div>
                    <label for="hero_intro_heading">Titre court</label>
                    <input type="text" id="hero_intro_heading" name="hero_intro_heading" required value="<%= heroIntro.heading %>">
                </div>
                <div>
                    <label for="hero_intro_subheading">Titre principal</label>
                    <input type="text" id="hero_intro_subheading" name="hero_intro_subheading" required value="<%= heroIntro.subheading %>">
                </div>
                <div>
                    <label for="hero_intro_body">Texte de pr√©sentation</label>
                    <textarea id="hero_intro_body" name="hero_intro_body" rows="5" required><%= heroIntro.body %></textarea>
                    <small>Mettez en avant votre style, votre ancrage √† Amiens et vos d√©placements partout en France.</small>
                </div>
                <button type="submit" class="button-primary">Enregistrer</button>
            </form>
        </section>

        <section class="admin-card admin-card--wide" id="experiences" data-admin-section="experiences">
            <h2>Exp√©riences mises en avant</h2>
            <p>G√©rez les rubans d'exp√©riences visibles sur l'accueil : ic√¥nes, images et textes peuvent √™tre personnalis√©s.</p>
            <div class="experience-manager">
                <div class="experience-manager__column">
                    <h3>Ajouter une exp√©rience</h3>
                    <form class="admin-form" method="post" action="/admin/experiences" enctype="multipart/form-data">
                        <div>
                            <label for="experience_title">Titre</label>
                            <input type="text" id="experience_title" name="title" required>
                        </div>
                        <div>
                            <label for="experience_description">Description</label>
                            <textarea id="experience_description" name="description" rows="3" required></textarea>
                            <small>Ce texte appara√Æt sous le titre sur la page d'accueil.</small>
                        </div>
                        <div>
                            <label for="experience_icon">Ic√¥ne (emoji ou caract√®re)</label>
                            <input type="text" id="experience_icon" name="icon" maxlength="8" placeholder="Exemple : üì∏">
                            <small>Facultatif si vous ajoutez une image.</small>
                        </div>
                        <div>
                            <label for="experience_image">Image</label>
                            <input type="file" id="experience_image" name="image" accept="image/*">
                            <small>Optionnelle. Remplace l'ic√¥ne si fournie.</small>
                        </div>
                        <div>
                            <label for="experience_position">Position</label>
                            <input type="number" id="experience_position" name="position" placeholder="0">
                            <small>Ordre d'affichage (plus petit = plus √† gauche).</small>
                        </div>
                        <button type="submit" class="button-primary">Ajouter</button>
                    </form>
                </div>
                <div class="experience-manager__column">
                    <h3>Exp√©riences existantes</h3>
                    <% if (!experiences || experiences.length === 0) { %>
                        <p>Aucune exp√©rience n'est d√©finie pour le moment. Ajoutez vos propositions cl√©s.</p>
                    <% } else { %>
                        <div class="experience-list">
                            <% experiences.forEach(experience => { %>
                                <article class="experience-item">
                                    <div class="experience-item__preview">
                                        <% if (experience.image_path) { %>
                                            <img src="<%= experience.image_path %>" alt="Illustration de <%= experience.title %>">
                                        <% } else if (experience.icon) { %>
                                            <span class="experience-item__icon"><%= experience.icon %></span>
                                        <% } else { %>
                                            <div class="experience-item__placeholder">Ic√¥ne ou image √† ajouter</div>
                                        <% } %>
                                    </div>
                                    <div class="experience-item__content">
                                        <form class="admin-form" method="post" action="/admin/experiences/<%= experience.id %>" enctype="multipart/form-data">
                                            <div>
                                                <label for="experience_title_<%= experience.id %>">Titre</label>
                                                <input type="text" id="experience_title_<%= experience.id %>" name="title" required value="<%= experience.title %>">
                                            </div>
                                            <div>
                                                <label for="experience_description_<%= experience.id %>">Description</label>
                                                <textarea id="experience_description_<%= experience.id %>" name="description" rows="3" required><%= experience.description %></textarea>
                                            </div>
                                            <div>
                                                <label for="experience_icon_<%= experience.id %>">Ic√¥ne</label>
                                                <input type="text" id="experience_icon_<%= experience.id %>" name="icon" value="<%= experience.icon || '' %>" maxlength="8" placeholder="Exemple : üì∏">
                                                <small>Laissez vide si vous pr√©f√©rez utiliser uniquement l'image.</small>
                                            </div>
                                            <div>
                                                <label for="experience_image_<%= experience.id %>">Remplacer l'image</label>
                                                <input type="file" id="experience_image_<%= experience.id %>" name="image" accept="image/*">
                                            </div>
                                            <% if (experience.image_path) { %>
                                                <label class="admin-form__checkbox">
                                                    <input type="checkbox" name="remove_image" value="on">
                                                    <span>Supprimer l'image actuelle</span>
                                                </label>
                                            <% } %>
                                            <div>
                                                <label for="experience_position_<%= experience.id %>">Position</label>
                                                <input type="number" id="experience_position_<%= experience.id %>" name="position" value="<%= typeof experience.position === 'number' ? experience.position : '' %>">
                                            </div>
                                            <div class="admin-photo-actions">
                                                <button type="submit" class="button-secondary">Enregistrer</button>
                                            </div>
                                        </form>
                                        <form class="admin-form admin-form--delete" method="post" action="/admin/experiences/<%= experience.id %>/delete" onsubmit="return confirm('Supprimer cette exp√©rience ?');">
                                            <button type="submit" class="button-danger">Supprimer</button>
                                        </form>
                                    </div>
                                </article>
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </div>
        </section>

        <section class="admin-card" id="contact-settings" data-admin-section="contact-settings">
            <h2>Param√®tres de contact</h2>
            <form class="admin-form" method="post" action="/admin/contact-email">
                <div>
                    <label for="contact_email">Email destinataire</label>
                    <input type="email" id="contact_email" name="contact_email" required value="<%= contactEmail %>">
                </div>
                <button type="submit" class="button-primary">Mettre √† jour</button>
            </form>
        </section>
    </div>

    <section class="admin-card admin-card--wide" id="categories" data-admin-section="categories">
        <h2>Cat√©gories du portfolio</h2>
        <p>Personnalisez les univers pr√©sent√©s sur la page d'accueil et assignez vos photos aux bonnes th√©matiques.</p>
        <div class="category-manager">
            <div class="category-manager__column">
                <h3>Cr√©er une cat√©gorie</h3>
                <form class="admin-form" method="post" action="/admin/categories" enctype="multipart/form-data">
                    <div>
                        <label for="category_name">Nom</label>
                        <input type="text" id="category_name" name="name" required>
                    </div>
                    <div>
                        <label for="category_position">Position</label>
                        <input type="number" id="category_position" name="position" min="0" placeholder="0">
                    </div>
                    <div>
                        <label for="category_hero_image">Image de mise en avant</label>
                        <input type="file" id="category_hero_image" name="hero_image" accept="image/*" required>
                        <small>Format conseill√© : photo horizontale. Cette image appara√Ætra dans la mosa√Øque d'accueil.</small>
                    </div>
                    <button type="submit" class="button-primary">Cr√©er</button>
                </form>
            </div>
            <div class="category-manager__column">
                <h3>Cat√©gories existantes</h3>
                <% if (!categories || categories.length === 0) { %>
                    <p>Aucune cat√©gorie d√©finie pour le moment. Cr√©ez vos univers pour structurer votre portfolio.</p>
                <% } else { %>
                    <div class="category-list">
                        <% categories.forEach(category => { %>
                            <article class="category-item">
                                <div class="category-item__preview">
                                    <% if (category.hero_image_path) { %>
                                        <img src="<%= category.hero_image_path %>" alt="Visuel de la cat√©gorie <%= category.name %>">
                                    <% } else { %>
                                        <div class="category-item__placeholder">Image √† ajouter</div>
                                    <% } %>
                                </div>
                                <div class="category-item__content">
                                    <form class="admin-form" method="post" action="/admin/categories/<%= category.id %>" enctype="multipart/form-data">
                                        <div>
                                            <label for="category_name_<%= category.id %>">Nom</label>
                                            <input type="text" id="category_name_<%= category.id %>" name="name" required value="<%= category.name %>">
                                        </div>
                                        <div>
                                            <label for="category_position_<%= category.id %>">Position</label>
                                            <input type="number" id="category_position_<%= category.id %>" name="position" value="<%= category.position %>">
                                        </div>
                                        <div>
                                            <label for="category_image_<%= category.id %>">Remplacer l'image</label>
                                            <input type="file" id="category_image_<%= category.id %>" name="hero_image" accept="image/*">
                                        </div>
                                        <div class="admin-photo-actions">
                                            <button type="submit" class="button-secondary">Enregistrer</button>
                                        </div>
                                    </form>
                                    <form class="admin-form admin-form--delete" method="post" action="/admin/categories/<%= category.id %>/delete" onsubmit="return confirm('Supprimer cette cat√©gorie ? Les photos associ√©es resteront en ligne sans cat√©gorie.');">
                                        <button type="submit" class="button-danger">Supprimer</button>
                                    </form>
                                </div>
                            </article>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </section>

    <section class="admin-card" id="photos" data-admin-section="photos">
        <h2>Vos photos</h2>
        <% if (!photos || photos.length === 0) { %>
            <p>Aucune photo pour le moment. Ajoutez vos ≈ìuvres pour les voir appara√Ætre ici.</p>
        <% } else { %>
            <% const palettes = { vibrant: 'Vibrant', chromatique: 'Chromatique', pastel: 'Pastel', solaire: 'Solaire' }; %>
            <div class="admin-photos">
                <% photos.forEach(photo => { %>
                    <article class="admin-photo-item">
                        <img src="<%= photo.image_path %>" alt="<%= photo.title %>">
                        <div>
                            <h3><%= photo.title %></h3>
                            <% if (photo.description) { %>
                                <p><%- nl2br(photo.description) %></p>
                            <% } %>
                            <form class="admin-form" method="post" action="/admin/photos/<%= photo.id %>" enctype="multipart/form-data">
                                <div>
                                    <label for="title_<%= photo.id %>">Titre</label>
                                    <input type="text" id="title_<%= photo.id %>" name="title" required value="<%= photo.title %>">
                                </div>
                                <div>
                                    <label for="description_<%= photo.id %>">Description</label>
                                    <textarea id="description_<%= photo.id %>" name="description" rows="3"><%= photo.description || '' %></textarea>
                                </div>
                                <div>
                                    <label for="palette_<%= photo.id %>">Palette</label>
                                    <select id="palette_<%= photo.id %>" name="palette">
                                        <% Object.entries(palettes).forEach(([value, label]) => { %>
                                            <option value="<%= value %>" <%= photo.palette === value ? 'selected' : '' %>><%= label %></option>
                                        <% }) %>
                                    </select>
                                </div>
                                <div>
                                    <label for="accent_<%= photo.id %>">Couleur d'accent</label>
                                    <input type="color" id="accent_<%= photo.id %>" name="accent_color" value="<%= photo.accent_color || '#ff6f61' %>">
                                </div>
                                <div>
                                    <label for="category_<%= photo.id %>">Cat√©gorie</label>
                                    <select id="category_<%= photo.id %>" name="category_id">
                                        <option value="" <%= !photo.category_id ? 'selected' : '' %>>Sans cat√©gorie</option>
                                        <% if (categories && categories.length) { %>
                                            <% categories.forEach(category => { %>
                                                <option value="<%= category.id %>" <%= photo.category_id === category.id ? 'selected' : '' %>><%= category.name %></option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                </div>
                                <div>
                                    <label for="photo_<%= photo.id %>">Remplacer l'image</label>
                                    <input type="file" id="photo_<%= photo.id %>" name="photo" accept="image/*">
                                </div>
                                <div class="admin-photo-actions">
                                    <button type="submit" class="button-secondary">Enregistrer</button>
                                </div>
                            </form>
                            <form class="admin-form admin-form--delete" method="post" action="/admin/photos/<%= photo.id %>/delete" onsubmit="return confirm('Supprimer cette photo ?');">
                                <button type="submit" class="button-danger">Supprimer</button>
                            </form>
                        </div>
                    </article>
                <% }) %>
            </div>
        <% } %>
    </section>

    <section class="admin-card" id="messages" data-admin-section="messages">
        <h2>Messages re√ßus</h2>
        <% if (!messages || messages.length === 0) { %>
            <p>Aucun message pour le moment.</p>
        <% } else { %>
            <ul class="admin-messages">
                <% messages.forEach(message => { %>
                    <li>
                        <header>
                            <strong><%= message.name %></strong> ‚Äì <a href="mailto:<%= message.email %>"><%= message.email %></a>
                            <span class="admin-message-date"><%= formatDate(message.created_at) %></span>
                        </header>
                        <p class="admin-message-subject"><strong>Objet :</strong> <%= message.subject %></p>
                        <p><%- nl2br(message.message) %></p>
                    </li>
                <% }) %>
            </ul>
        <% } %>
    </section>
    <script>
        (function () {
            const triggers = Array.from(document.querySelectorAll('[data-admin-target]'));
            const sections = Array.from(document.querySelectorAll('[data-admin-section]'));

            if (!triggers.length || !sections.length) {
                return;
            }

            const sectionsById = new Map(sections.map(section => [section.dataset.adminSection, section]));

            function activate(target, options) {
                const { scroll = true } = options || {};
                const activeSection = sectionsById.get(target);
                if (!activeSection) {
                    return;
                }

                sections.forEach(section => {
                    section.hidden = section !== activeSection;
                });

                triggers.forEach(trigger => {
                    trigger.classList.toggle('is-active', trigger.dataset.adminTarget === target);
                });

                if (window.location.hash !== `#${target}` && typeof history.replaceState === 'function') {
                    history.replaceState(null, '', `#${target}`);
                }

                if (scroll) {
                    activeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    activate(trigger.dataset.adminTarget, { scroll: true });
                });
            });

            const initialHash = window.location.hash ? window.location.hash.substring(1) : '';
            const initialTarget = sectionsById.has(initialHash)
                ? initialHash
                : triggers[0] && triggers[0].dataset.adminTarget;

            if (initialTarget) {
                activate(initialTarget, { scroll: false });
            }
        })();
    </script>
</section>
<%- include('../partials/footer') %>
